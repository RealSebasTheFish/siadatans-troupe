<!DOCTYPE html>
<html>
    <head>
        <title>Pathwise</title>
        <link rel="stylesheet" type="text/css" href="main.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <script src="https://cdn.socket.io/4.8.0/socket.io.min.js" integrity="sha384-OoIbkvzsFFQAG88r+IqMAjyOtYDPGO0cqK5HF5Uosdy/zUEGySeAzytENMDynREd" crossorigin="anonymous"></script>
        <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCnaiOvJieIvUWy2VJxugGrq6n-hWN6nv4&libraries=drawing"></script>

        <script>
            const socket = io("https://fb85-199-212-64-70.ngrok-free.app/", { transports : ['websocket'] });
            console.log(socket);

            let map;
            let drawingManager;

            $(document).ready(function(){
                socket.on("connect", () => {
                    console.log("Connection Successful!");
                });

                socket.on("response-packet", function(data) {
                    data["type"]
                });

                initMap(); // Initialize the map on document ready

            });

            function openReportMenu() {
                $("#report-select-menu").css("display", "block");
            }

            function closeReportMenu() {
                $("#report-select-menu").css("display", "none");
            }


            function openIncentiveMenu() {
                $("#incentive-select-menu").css("display", "block");
            }

            function closeIncentiveMenu() {
                $("#incentive-select-menu").css("display", "none");
            }

            function report(type) {
                var latitude = null;
                var longitude = null;
                var name = null;
                const data = {
                    "type": type, // Ping type
                    "location": {
                        "latitude": latitude, // location part 1
                        "longitude": longitude // location part 2
                    },
                    "timestamp": new Date().toISOString(), // timestamp from the server
                    "username": name, // username input
                };

                socket.emit("report-packet", data);

            }

            // Initialize and add the Google Map
            function initMap() {
            const center = { lat: 43.7735, lng: -79.5019 }; // Center of the map

            // Create the map
            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 13,
                center: center,
            });

            // Initialize Drawing Manager
            drawingManager = new google.maps.drawing.DrawingManager({
                drawingMode: google.maps.drawing.OverlayType.POLYLINE, // Allow drawing polylines
                drawingControl: true,
                drawingControlOptions: {
                    position: google.maps.ControlPosition.TOP_CENTER,
                    drawingModes: [
                        google.maps.drawing.OverlayType.POLYLINE,
                    ],
                },
                polylineOptions: {
                    strokeColor: '#0000FF', // Color of the drawn polyline
                    strokeWeight: 3,
                    editable: true, // Allow the drawn polyline to be editable
                },
            });

            // Display the drawing tools on the map
            drawingManager.setMap(map);

            // Add event listener for the completion of a polyline drawing
            google.maps.event.addListener(drawingManager, "overlaycomplete", (event) => {
                if (event.type === google.maps.drawing.OverlayType.POLYLINE) {
                    const path = event.overlay.getPath().getArray();
                    const coordinates = path.map(latlng => ({
                        latitude: latlng.lat(),
                        longitude: latlng.lng()
                    }));
                    console.log("Polyline drawn:", coordinates);
                    
                    // Emit the drawn coordinates
                    report('drawn-path', coordinates);
                }
            });
        }
        </script>
    </head>
    <body>
        <div id="map"></div>
        <button id="report-button" onclick="openReportMenu();"><img id="report-button-image" src="img/caution.png" /></button>
        <button id="incentive-button" onclick="openIncentiveMenu();"><img id="incentive-button-image" src="img/dollar-sign.png" /></button>
        <div id="report-select-menu">
            <table>
                <tr>
                    <td class="report-image" onclick="report('police');"><img src="img/police.png" /></td>
                    <td class="report-image" onclick="report('crash');"><img src="img/crash.png" /></td>
                    <td class="report-image" onclick="report('pothole');"><img src="img/pothole.png" /></td>
                </tr>
                <tr>
                    <td class="report-image" onclick="report('blocked-lane');"><img src="img/blocked-lane.png" /></td>
                    <td class="report-image" onclick="report('bad-weather');"><img src="img/bad-weather.png" /></td>
                    <td class="report-image" onclick="report('construction');"><img src="img/construction.png" /></td>
                </tr>
                <tr>
                    <td class="report-image" onclick="report('car-on-shoulder');"><img src="img/car-on-shoulder.png" /></td>
                    <td class="report-image" onclick="report('gas-prices');"><img src="img/gas-prices.png" /></td>
                    <td class="report-image" onclick="closeReportMenu();"><img src="img/x.png" /></td>
                </tr>
            </table>
        </div>

        <div id="incentive-select-menu">
            <img id="close-incentive-menu" onclick="closeIncentiveMenu();" src="img/x.png" />
            <table id="incentives">
                <tr><td class="incentive-entry">
                    <h2 class="incentive-title">Louise's Bakery</h2>
                    <img class="incentive-image" src="img/louis.png"/>
                    <p class="incentive-description">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer non sapien laoreet, gravida metus eget, tristique nisl. In non mollis augue. Fusce a dui rhoncus arcu semper semper. Cras ac neque ac mauris efficitur convallis. Sed nunc nulla, mattis et arcu nec, molestie tincidunt neque. Vestibulum vitae nisl commodo, feugiat lectus sed, rhoncus magna. In ac eleifend leo. Quisque volutpat eu libero eget venenatis. Morbi auctor nunc et enim hendrerit luctus.</p>
                </td></tr>
                <tr><td class="incentive-entry">
                    <h2 class="incentive-title">Bob's Convenience</h2>
                    <img class="incentive-image" src="img/bob.png"/>
                    <p class="incentive-description">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer non sapien laoreet, gravida metus eget, tristique nisl. In non mollis augue. Fusce a dui rhoncus arcu semper semper. Cras ac neque ac mauris efficitur convallis. Sed nunc nulla, mattis et arcu nec, molestie tincidunt neque. Vestibulum vitae nisl commodo, feugiat lectus sed, rhoncus magna. In ac eleifend leo. Quisque volutpat eu libero eget venenatis. Morbi auctor nunc et enim hendrerit luctus.</p>
                </td></tr>
                <tr><td class="incentive-entry">
                    <h2 class="incentive-title">Gregs's Eatery</h2>
                    <img class="incentive-image" src="img/greg.png"/>
                    <p class="incentive-description">Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer non sapien laoreet, gravida metus eget, tristique nisl. In non mollis augue. Fusce a dui rhoncus arcu semper semper. Cras ac neque ac mauris efficitur convallis. Sed nunc nulla, mattis et arcu nec, molestie tincidunt neque. Vestibulum vitae nisl commodo, feugiat lectus sed, rhoncus magna. In ac eleifend leo. Quisque volutpat eu libero eget venenatis. Morbi auctor nunc et enim hendrerit luctus.</p>
                </td></tr>
            </table>
        </div>
    </body>
</html>